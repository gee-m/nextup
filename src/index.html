<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tree</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234f46e5'/%3E%3Cstop offset='100%25' style='stop-color:%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g)' width='32' height='32' rx='6'/%3E%3Cpath stroke='%23fff' stroke-width='2' fill='none' d='M16 8v6m0 0l-6 4m6-4l6 4'/%3E%3Ccircle cx='16' cy='8' r='2.5' fill='%23fff'/%3E%3Ccircle cx='10' cy='18' r='2.5' fill='%23fff'/%3E%3Ccircle cx='22' cy='18' r='2.5' fill='%23fff'/%3E%3Cpath stroke='%23fff' stroke-width='1.5' fill='none' d='M10 20.5v3.5m12-3.5v3.5'/%3E%3Ccircle cx='10' cy='26' r='2' fill='%23fbbf24'/%3E%3Ccircle cx='22' cy='26' r='2' fill='%2310b981'/%3E%3C/svg%3E">
    <!-- JSZip library for .zip export/import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- CSS_INJECT -->
</head>
<body>
    <div id="controls">
        <button style="background: #9c27b0; color: white;" onclick="app.loadTestChecklist()" title="Load testing tasks for recent features">üß™ Test Checklist</button>
        <button class="secondary" onclick="app.toggleDarkMode()" id="darkModeToggle">üåô Dark Mode</button>
        <button class="secondary" onclick="app.toggleDebugCtrlMode()" id="debugCtrlToggle" title="Debug mode: All clicks/drags act as if Ctrl is pressed">üîß Debug: Ctrl OFF</button>
        <button class="secondary" onclick="app.showSettingsModal()" title="Customize appearance and behavior">‚öôÔ∏è Settings</button>
        <button class="secondary" onclick="app.showShortcutsModal()" title="View all keyboard shortcuts">‚ùì Shortcuts</button>
        <button class="secondary" onclick="app.showTimeTrackingDashboard()" title="View time tracking overview and export data">‚è±Ô∏è Time Tracking</button>
        <div class="dropdown">
            <button class="secondary" onclick="app.toggleHomesDropdown(event)" title="Quick navigation to saved homes">üè† Homes</button>
            <div id="homesDropdown" class="dropdown-content">
                <!-- Populated dynamically by renderHomesDropdown() -->
            </div>
        </div>
        <button class="secondary" onclick="app.exportData()">Export JSON</button>
        <button class="secondary" onclick="app.copyDataToClipboard(event)">Copy JSON</button>
        <button class="secondary" onclick="app.showImportModal()">Import JSON</button>
        <button class="secondary" onclick="app.repairWorkingTasks()">üîß Repair Data</button>
        <button class="secondary" onclick="app.clearAllData()">Clear All Data</button>
        <div class="info">
            <span id="shortcuts-help"></span>
        </div>
    </div>

    <div id="canvas-container">
        <svg id="canvas">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" class="marker" />
                </marker>
                <marker id="arrowhead-golden" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#f59e0b" />
                </marker>
                <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#f44336" />
                </marker>
                <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#4caf50" />
                </marker>
                <marker id="arrowhead-temp-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#28a745" />
                </marker>

                <!-- Priority stripe patterns for light mode (thin solid stripes) -->
                <pattern id="priority-high-light" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <rect x="0" y="0" width="8" height="8" fill="#fff" />
                    <rect x="0" y="0" width="1.5" height="8" fill="#ffcdd2" />
                </pattern>
                <pattern id="priority-medium-light" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <rect x="0" y="0" width="8" height="8" fill="#fff" />
                    <rect x="0" y="0" width="1.5" height="8" fill="#ffe0b2" />
                </pattern>

                <!-- Priority stripe patterns for dark mode (thin solid stripes) -->
                <pattern id="priority-high-dark" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <rect x="0" y="0" width="8" height="8" fill="#2d3748" />
                    <rect x="0" y="0" width="1.5" height="8" fill="#d32f2f" />
                </pattern>
                <pattern id="priority-medium-dark" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <rect x="0" y="0" width="8" height="8" fill="#2d3748" />
                    <rect x="0" y="0" width="1.5" height="8" fill="#f57c00" />
                </pattern>
            </defs>
            <g id="links"></g>
            <g id="nodes"></g>
        </svg>

        <!-- Off-screen indicators for working tasks and homes -->
        <div class="offscreen-indicators" id="offscreen-indicators"></div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h2>Import Data</h2>
            <p>Choose a .zip or .json file, or paste JSON below:</p>
            <input type="file" id="import-file" accept=".zip,.json" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <p style="text-align: center; margin: 10px 0; color: #666;">‚Äî OR ‚Äî</p>
            <textarea id="import-textarea" placeholder="Paste JSON here..."></textarea>
            <div class="modal-buttons">
                <button onclick="app.importData()">Import</button>
                <button class="secondary" onclick="app.hideImportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="confirm-title"></h2>
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-yes">Yes</button>
                <button class="secondary" id="confirm-no">Cancel</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h2 id="alert-title"></h2>
            <p id="alert-message"></p>
            <div class="modal-buttons">
                <button id="alert-ok">OK</button>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="modal">
        <div class="modal-content">
            <h2 id="prompt-title"></h2>
            <p id="prompt-message"></p>
            <input type="text" id="prompt-input" placeholder="" style="width: 100%; padding: 8px; margin: 10px 0; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
            <div class="modal-buttons">
                <button id="prompt-ok">OK</button>
                <button class="secondary" id="prompt-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow-y: auto; padding: 16px;">
            <h2 style="margin-bottom: 8px;">‚öôÔ∏è Settings</h2>
            <p style="color: #666; font-size: 12px; margin-bottom: 12px;">Customize appearance and behavior</p>
            <div id="settings-form"></div>

            <!-- History Management Section -->
            <div style="margin-top: 20px; padding-top: 12px; border-top: 2px solid #ddd;">
                <h3 style="margin-bottom: 10px; font-size: 15px;">üìú History Management</h3>
                <div id="history-stats" style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                    <div style="margin-bottom: 6px;">
                        <strong>Current History:</strong>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                        <li>Undo steps: <span id="undo-count">0</span> / <span id="undo-limit">50</span></li>
                        <li>Redo steps: <span id="redo-count">0</span></li>
                        <li>Memory estimate: ~<span id="history-size">0</span> KB</li>
                    </ul>
                </div>
                <button
                    onclick="app.clearUndoHistory()"
                    style="background: #f44336; color: white; border: 1px solid #d32f2f; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%;"
                    onmouseover="this.style.background='#d32f2f'"
                    onmouseout="this.style.background='#f44336'">
                    üóëÔ∏è Clear Undo/Redo History
                </button>
                <p style="font-size: 11px; color: #666; margin-top: 6px; margin-bottom: 0;">
                    Removes all undo/redo history to free up storage space. This action cannot be undone.
                </p>
            </div>

            <div class="modal-buttons">
                <button onclick="app.applySettings()">Apply</button>
                <button class="secondary" onclick="app.exportSettings()">Export Settings</button>
                <button class="secondary" onclick="app.resetSettings()">Reset to Defaults</button>
                <button class="secondary" onclick="app.hideSettingsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="create-home-modal" class="modal">
        <div class="modal-content">
            <h2>Create New Home</h2>
            <p>Enter a name for this home bookmark:</p>
            <input type="text" id="home-name-input" placeholder="Home name..." maxlength="50" />
            <p style="font-size: 12px; color: #666; margin-top: 8px;">
                This will save your current view position and zoom level.
            </p>
            <div class="modal-buttons">
                <button onclick="app.createHomeFromModal()">Create</button>
                <button class="secondary" onclick="app.hideCreateHomeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="manage-homes-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üè† Manage Homes</h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
                Manage your saved home bookmarks
            </p>
            <div id="homes-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Populated dynamically by renderManageHomesModal() -->
            </div>
            <div class="modal-buttons">
                <button class="secondary" onclick="app.hideManageHomesModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="shortcuts-modal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <p id="shortcuts-platform-info" style="color: #666; font-size: 13px; margin-bottom: 20px;"></p>

            <div id="shortcuts-content" style="display: grid; gap: 24px;">
                <!-- Populated dynamically by showShortcutsModal() -->
            </div>

            <div class="modal-buttons" style="margin-top: 24px;">
                <button onclick="app.hideShortcutsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="time-history-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h2>‚è±Ô∏è Time Tracking History</h2>
            <div id="time-history-content">
                <!-- Populated dynamically by showTimeHistoryModal() -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button onclick="app.hideTimeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="time-dashboard-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <h2>‚è±Ô∏è Time Tracking Dashboard</h2>
            <div id="time-dashboard-content">
                <!-- Populated dynamically by showTimeTrackingDashboard() -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button onclick="app.hideTimeTrackingDashboard()">Close</button>
            </div>
        </div>
    </div>

    <div id="emoji-picker-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="emoji-picker-title">Select Emoji Icon</h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 16px;">Click an emoji or type one in the box:</p>
            <input type="text" id="emoji-custom-input" placeholder="Or type/paste an emoji..." maxlength="10" style="width: 100%; padding: 8px; margin-bottom: 16px; font-size: 24px; text-align: center; border: 1px solid #ccc; border-radius: 4px;">
            <div id="emoji-picker-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                <!-- Populated dynamically by showEmojiPicker() -->
            </div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button id="emoji-picker-ok">OK</button>
                <button class="secondary" id="emoji-picker-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="status-bar">
        <span class="status-label">Working on:</span>
        <span id="status-path"></span>
        <span class="status-detail" id="status-children"></span>
        <div style="display: flex; gap: 0; margin-left: auto;">
            <button id="jump-to-working-btn" class="status-btn" onclick="app.jumpToWorkingTask()" style="border-radius: 4px 0 0 4px; padding-right: 8px; margin-left: 0;">
                üéØ Jump
            </button>
            <button id="jump-dropdown-btn" class="status-btn" onclick="app.showWorkingTasksDropdown(event)" style="border-radius: 0 4px 4px 0; padding: 4px 6px; border-left: 1px solid rgba(255,255,255,0.2); min-width: auto; margin-left: 0;" title="Choose working task">
                ‚ñ≤
            </button>
        </div>
    </div>

    <!-- Timer Window (floating) -->
    <div id="timer-window"></div>

    <!-- JS_INJECT -->
</body>
</html>
